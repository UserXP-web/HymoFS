name: Build LKM for HymoFS

on:
  workflow_call:
  workflow_dispatch:
  push:
    branches:
      - lkm

jobs:
  build-lkm:
    strategy:
      fail-fast: false
      matrix:
        kmi:
          - android15-6.6
    uses: ./.github/workflows/ddk-lkm.yml
    secrets: inherit
    with:
      kmi: ${{ matrix.kmi }}
      ddk_release: "20251104"

  trigger-hymo:
    name: Trigger hymo build-lkm
    needs: build-lkm
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      # 使用 workflow_dispatch API 显式触发 build.yml，避免 repository_dispatch 依赖默认分支
      - name: Trigger hymo workflow_dispatch
        env:
          HYMO_REPO: Anatdx/hymo
          HYMO_TRIGGER_TOKEN: ${{ secrets.HYMO_TRIGGER_TOKEN }}
          HYMOFS_REF: ${{ github.ref_name }}
          # 触发 hymo 的哪个分支上的 workflow（与 HymoFS 分支对应：lkm → hymo lkm）
          HYMO_REF: ${{ github.ref_name }}
        run: |
          if [ -z "$HYMO_TRIGGER_TOKEN" ]; then
            echo "HYMO_TRIGGER_TOKEN not set, skip triggering hymo."
            exit 0
          fi
          echo "Triggering $HYMO_REPO workflow build.yml (hymo ref=$HYMO_REF, hymofs ref=$HYMOFS_REF)"
          # 不传 inputs，避免目标仓库 main 上 workflow 未定义 hymofs_ref 时 422；hymo 内用默认 lkm
          resp=$(curl -sS -w "\n%{http_code}" -X POST "https://api.github.com/repos/${HYMO_REPO}/actions/workflows/build.yml/dispatches" \
            -H "Authorization: token ${HYMO_TRIGGER_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{\"ref\":\"${HYMO_REF}\"}")
          code=$(echo "$resp" | tail -n1)
          echo "Response: HTTP $code"
          if [ "$code" != "204" ]; then
            echo "::error::Trigger failed"
            echo "$resp" | sed '$d'
            exit 1
          fi
          echo "Trigger sent. Check Actions in $HYMO_REPO."
