name: Build LKM for HymoFS

on:
  workflow_call:
  workflow_dispatch:
  push:
    branches:
      - lkm

jobs:
  build-lkm:
    strategy:
      fail-fast: false
      matrix:
        kmi:
          - android15-6.6
    uses: ./.github/workflows/ddk-lkm.yml
    secrets: inherit
    with:
      kmi: ${{ matrix.kmi }}
      ddk_release: "20251104"

  trigger-hymo:
    name: Trigger hymo build-lkm
    needs: build-lkm
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      # 使用 workflow_dispatch API 显式触发 build.yml，并传入 HymoFS 的 commit 信息供 TG 详情展示
      - name: Trigger hymo workflow_dispatch
        env:
          HYMO_REPO: Anatdx/hymo
          HYMO_TRIGGER_TOKEN: ${{ secrets.HYMO_TRIGGER_TOKEN }}
          HYMOFS_REF: ${{ github.ref_name }}
          HYMO_REF: ${{ github.ref_name }}
          HYMOFS_SHA: ${{ github.sha }}
          HYMOFS_MSG: ${{ github.event.head_commit.message }}
        run: |
          if [ -z "$HYMO_TRIGGER_TOKEN" ]; then
            echo "HYMO_TRIGGER_TOKEN not set, skip triggering hymo."
            exit 0
          fi
          echo "Triggering $HYMO_REPO workflow build.yml (hymo ref=$HYMO_REF, hymofs ref=$HYMOFS_REF, sha=$HYMOFS_SHA)"
          payload=$(jq -n \
            --arg ref "$HYMO_REF" \
            --arg ref_name "$HYMOFS_REF" \
            --arg sha "$HYMOFS_SHA" \
            --arg msg "$HYMOFS_MSG" \
            '{ref: $ref, inputs: {hymofs_ref: $ref_name, hymofs_sha: $sha, hymofs_commit_message: $msg}}')
          resp=$(curl -sS -w "\n%{http_code}" -X POST "https://api.github.com/repos/${HYMO_REPO}/actions/workflows/build.yml/dispatches" \
            -H "Authorization: token ${HYMO_TRIGGER_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            -d "$payload")
          code=$(echo "$resp" | tail -n1)
          echo "Response: HTTP $code"
          if [ "$code" != "204" ]; then
            echo "::error::Trigger failed"
            echo "$resp" | sed '$d'
            exit 1
          fi
          echo "Trigger sent. Check Actions in $HYMO_REPO."
