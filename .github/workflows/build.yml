name: Build HymoFS KPM

on:
  push:
    branches: ["kpm"]
    tags: ["*"]
  pull_request:
    branches: ["kpm"]
  workflow_dispatch:
    inputs:
      kmi:
        description: "DDK KMI version (docker tag prefix)"
        required: false
        default: "android15-6.6"
        type: string
      ddk_release:
        description: "DDK release version (docker tag suffix)"
        required: false
        default: "20251104"
        type: string

jobs:
  build-kpm:
    name: Build HymoFS KPM
    runs-on: ubuntu-latest
    timeout-minutes: 20
    container:
      # Provide a complete kernel build environment + kernel sources/headers.
      # Refer to YukiSU/.github/workflows/ddk-lkm.yml
      image: ghcr.io/ylarod/ddk:${{ inputs.kmi || 'android15-6.6' }}-${{ inputs.ddk_release || '20251104' }}
      options: --privileged
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build (release + debug)
        run: |
          set -euxo pipefail
          # GitHub checkout inside container needs this sometimes.
          git config --global --add safe.directory /__w/HymoFS/HymoFS || true

          # Detect kernel source directory provided by DDK image.
          # Note: some setups keep kernel sources under the checked-out workspace
          # (e.g. patch_workspace/<kmi>/common). So search both container-global
          # locations and workspace-relative locations.
          KMI="${{ inputs.kmi || 'android15-6.6' }}"
          KERNEL_SRC=""
          for d in \
            "$PWD/patch_workspace/${KMI}/common" \
            "$PWD/patch_workspace/${KMI}" \
            "$PWD/${KMI}/common" \
            "$PWD/common" \
            "/kernel" \
            "/android/kernel" \
            "/usr/src/kernel" \
            "/usr/src/android-kernel" \
            "/opt/kernel" \
            "/work/kernel" \
            "/ddk/kernel" \
            "/src/kernel" \
            "/common" \
            "/${KMI}/common" \
            ; do
            if [ -f "$d/Makefile" ] && [ -f "$d/include/linux/kconfig.h" ]; then
              KERNEL_SRC="$d"
              break
            fi
          done
          if [ -z "$KERNEL_SRC" ]; then
            echo "WARN: cannot locate kernel source in container image."
            echo "pwd=$PWD"
            echo "Attempting to fetch Android common kernel sources for ${KMI}..."

            # Place sources under patch_workspace/<kmi>/common to match local dev layout.
            mkdir -p "$PWD/patch_workspace/${KMI}"

            # Prefer the exact KMI branch; fallback to -lts if needed.
            if ! git clone --depth 1 --single-branch --branch "${KMI}" \
              https://android.googlesource.com/kernel/common \
              "$PWD/patch_workspace/${KMI}/common"; then
              echo "WARN: clone branch ${KMI} failed, trying ${KMI}-lts"
              rm -rf "$PWD/patch_workspace/${KMI}/common"
              git clone --depth 1 --single-branch --branch "${KMI}-lts" \
                https://android.googlesource.com/kernel/common \
                "$PWD/patch_workspace/${KMI}/common"
            fi

            KERNEL_SRC="$PWD/patch_workspace/${KMI}/common"
          fi

          if [ ! -f "$KERNEL_SRC/Makefile" ] || [ ! -f "$KERNEL_SRC/include/linux/kconfig.h" ]; then
            echo "ERROR: KERNEL_SRC is still invalid: $KERNEL_SRC"
            echo "Hint: ensure the DDK image includes kernel sources, or allow CI to clone:"
            echo "  - https://android.googlesource.com/kernel/common (branch ${KMI})"
            exit 1
          fi

          echo "Using KERNEL_SRC=$KERNEL_SRC"

          make -C hymofs_kpm clean || true
          # Build with toolchain provided by the container image.
          # We override CC/LD/OBJCOPY to avoid relying on Android NDK layout.
          make -C hymofs_kpm \
            KERNEL_SRC="$KERNEL_SRC" \
            CC=clang LD=ld.lld OBJCOPY=llvm-objcopy
          make -C hymofs_kpm debug \
            KERNEL_SRC="$KERNEL_SRC" \
            CC=clang LD=ld.lld OBJCOPY=llvm-objcopy || true
          ls -lah ./hymofs_*.kpm

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          # DDK images may not include gpg by default.
          (command -v gpg >/dev/null 2>&1) || (apt-get update && apt-get install -y gnupg)
          if [ -n "${GPG_PRIVATE_KEY:-}" ]; then
            echo "$GPG_PRIVATE_KEY" | gpg --batch --import
            echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
            gpgconf --kill gpg-agent
          fi

      - name: GPG sign KPMs
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_FINGERPRINT: ${{ secrets.GPG_FINGERPRINT }}
        run: |
          set -euo pipefail
          if [ -z "${GPG_PRIVATE_KEY:-}" ]; then
            echo "GPG_PRIVATE_KEY not set, skipping."
            exit 0
          fi
          KEY_ARG=""
          if [ -n "${GPG_FINGERPRINT:-}" ]; then
            KEY_ARG="--local-user ${GPG_FINGERPRINT}"
          fi
          for f in hymofs_*.kpm; do
            [ -f "$f" ] || continue
            gpg --batch --yes --pinentry-mode loopback --passphrase "${GPG_PASSPHRASE:-}" $KEY_ARG --detach-sign "$f"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hymofs-kpm-${{ github.sha }}
          if-no-files-found: error
          path: |
            hymofs_*.kpm
            hymofs_*.kpm.sig

      - name: Post to Telegram
        if: ${{ github.event_name != 'pull_request' && github.ref == 'refs/heads/main' && github.ref_type != 'tag' }}
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MESSAGE_THREAD_ID: ${{ secrets.MESSAGE_THREAD_ID }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          COMMIT_ID: ${{ github.sha }}
        run: |
          set -euo pipefail
          if [ -z "${BOT_TOKEN:-}" ] || [ -z "${CHAT_ID:-}" ]; then
            echo "BOT_TOKEN/CHAT_ID not set, skipping."
            exit 0
          fi
          python3 -m pip install --upgrade pip
          # pick first (release) kpm; if missing, fallback to any
          KPM_FILE="$(ls -1 hymofs_*.kpm | head -n1)"
          SIG_FILE="${KPM_FILE}.sig"
          if [ ! -f "$KPM_FILE" ] || [ ! -f "$SIG_FILE" ]; then
            echo "Missing kpm/sig, skipping."
            exit 0
          fi
          URL="$(python3 .github/scripts/telegram_url.py "$CHAT_ID")"
          curl -fsSL -X POST "$URL" \
            -F "Release1=@${KPM_FILE}"

      - name: Release artifacts (tag)
        if: ${{ github.ref_type == 'tag' }}
        uses: ncipollo/release-action@v1
        with:
          token: ${{ github.token }}
          artifacts: hymofs_*.kpm,hymofs_*.kpm.sig
          generateReleaseNotes: true
          makeLatest: true
          replacesArtifacts: true
