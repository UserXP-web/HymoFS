name: Build HymoFS Kernel Module

on:
  workflow_call:
    inputs:
      kmi:
        description: "KMI version"
        required: true
        type: string
      ddk_release:
        description: "Legacy input (kept for compatibility)"
        required: false
        default: "20251104"
        type: string
      kernel_repo_url:
        description: "Kernel repository URL"
        required: false
        default: "https://android.googlesource.com/kernel/common"
        type: string
      kernel_ref:
        description: "Kernel ref/branch (empty: use kmi, e.g. android15-6.6)"
        required: false
        default: ""
        type: string

jobs:
  build-hymofs-ko:
    name: Build hymofs_lkm.ko for ${{ inputs.kmi }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version
        id: parse_version
        run: |
          COMMIT_NUM=$(git rev-list --count HEAD)
          VERSION=$(echo "$COMMIT_NUM + 200" | bc)
          echo "Generated Version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git make clang lld llvm \
            flex bison bc rsync cpio \
            libelf-dev libssl-dev pahole zip

      - name: Fetch kernel tree
        run: |
          set -euo pipefail
          KMI="${{ inputs.kmi }}"
          KERNEL_REPO_URL="${{ inputs.kernel_repo_url }}"
          KERNEL_REF="${{ inputs.kernel_ref }}"
          if [ -z "$KERNEL_REF" ]; then
            KERNEL_REF="$KMI"
          fi

          KERNEL_SRC="$GITHUB_WORKSPACE/kernel"
          rm -rf "$KERNEL_SRC"
          echo "Cloning kernel tree: $KERNEL_REPO_URL @$KERNEL_REF"
          git clone --depth=1 --branch "$KERNEL_REF" "$KERNEL_REPO_URL" "$KERNEL_SRC"
          test -f "$KERNEL_SRC/Makefile"
          echo "Kernel tree ready at: $KERNEL_SRC"

      - name: Build hymofs_lkm.ko
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE" || true
          KMI="${{ inputs.kmi }}"
          KERNEL_REPO_URL="${{ inputs.kernel_repo_url }}"
          KERNEL_REF="${{ inputs.kernel_ref }}"
          if [ -z "$KERNEL_REF" ]; then
            KERNEL_REF="$KMI"
          fi
          KERNEL_SRC="$GITHUB_WORKSPACE/kernel"
          SRC="$GITHUB_WORKSPACE/src"

          if [ ! -f "$KERNEL_SRC/Makefile" ]; then
            echo "Kernel tree not found at $KERNEL_SRC"
            echo "Kernel source expected from: $KERNEL_REPO_URL@$KERNEL_REF"
            exit 1
          fi

          echo "Preparing kernel tree..."
          make -C "$KERNEL_SRC" ARCH=arm64 LLVM=1 gki_defconfig || \
            make -C "$KERNEL_SRC" ARCH=arm64 LLVM=1 defconfig
          make -C "$KERNEL_SRC" ARCH=arm64 LLVM=1 modules_prepare

          echo "Building hymofs_lkm.ko..."
          make -C "$KERNEL_SRC" ARCH=arm64 LLVM=1 M="$SRC" KBUILD_MODPOST_WARN=1 modules
          ls -la "$SRC"/hymofs_lkm.ko
          llvm-strip -d "$SRC"/hymofs_lkm.ko

      - name: Package minimal Magisk module
        run: |
          set -euo pipefail
          KMI="${{ inputs.kmi }}"
          SRC="$GITHUB_WORKSPACE/src"
          OUT="$GITHUB_WORKSPACE/out"
          MODDIR="$OUT/hymofs_lkm_magisk"
          TEMPLATE_DIR="$GITHUB_WORKSPACE/module"

          if [ ! -f "$TEMPLATE_DIR/module.prop" ] || [ ! -f "$TEMPLATE_DIR/post-fs-data.sh" ]; then
            echo "Module template is missing under $TEMPLATE_DIR"
            exit 1
          fi

          mkdir -p "$OUT"
          rm -rf "$MODDIR"
          cp -a "$TEMPLATE_DIR" "$MODDIR"
          cp "$SRC/hymofs_lkm.ko" "$OUT/${KMI}_hymofs_lkm.ko"
          cp "$SRC/hymofs_lkm.ko" "$MODDIR/hymofs_lkm.ko"
          chmod 0755 "$MODDIR/post-fs-data.sh"

          (cd "$MODDIR" && zip -r "$OUT/${KMI}_hymofs_lkm_magisk.zip" .)

          ls -la "$OUT"

      - name: Upload raw .ko
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.kmi }}_hymofs_lkm.ko
          path: out/${{ inputs.kmi }}_hymofs_lkm.ko

      - name: Upload Magisk module zip
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.kmi }}_hymofs_lkm_magisk
          path: out/${{ inputs.kmi }}_hymofs_lkm_magisk.zip

      - name: Post to Telegram
        if: ${{ github.event_name != 'pull_request' }}
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          SESSION_STRING: ${{ secrets.SESSION_STRING }}
          CHAT_ID: ${{ vars.CHAT_ID }}
          MESSAGE_THREAD_ID: ${{ vars.MESSAGE_THREAD_ID }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          TITLE: "HymoFS LKM (${{ inputs.kmi }})"
          VERSION: ${{ steps.parse_version.outputs.VERSION }}
          BRANCH: ${{ github.ref_name }}
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "BOT_TOKEN/CHAT_ID not set, skipping."
            exit 0
          fi
          pip install telethon==1.34.0
          KO="out/${{ inputs.kmi }}_hymofs_lkm.ko"
          ZIP="out/${{ inputs.kmi }}_hymofs_lkm_magisk.zip"
          FILES=""
          [ -f "$KO" ] && FILES="$KO"
          [ -f "$ZIP" ] && FILES="$FILES $ZIP"
          if [ -n "$FILES" ]; then
            python3 scripts/hymobot.py $FILES
          else
            echo "No files to upload"
          fi
